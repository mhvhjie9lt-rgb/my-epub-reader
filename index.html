<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Ultimate Web Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    
    <style>
        /* CSS 변수 선언 (테마별 색상 관리) */
        :root {
            --primary-color: #3498db;
            --bg-color: #f8f9fa; /* 웹페이지 배경 */
            --panel-bg: #ffffff; /* 헤더/푸터/설정바 배경 */
            --text-color: #333333; /* 기본 텍스트 색상 */
            --border-color: #eeeeee;
        }

        /* 테마별 클래스 정의 */
        body.sepia-theme {
            --bg-color: #f2eecb; --panel-bg: #f4ecd8; --text-color: #5b4636; --border-color: #e0d9b9;
        }
        body.dark-theme {
            --bg-color: #121212; --panel-bg: #1e1e1e; --text-color: #cccccc; --border-color: #333333;
        }

        /* 기본 레이아웃 */
        body {
            margin: 0; padding: 0; font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            display: flex; flex-direction: column; height: 100vh;
            background-color: var(--bg-color); color: var(--text-color);
            transition: background-color 0.3s, color 0.3s; /* 부드러운 색상 전환 */
            overflow: hidden;
        }

        /* 공통 UI 요소 스타일 */
        button {
            padding: 6px 12px; border: 1px solid var(--border-color); background: var(--panel-bg); color: var(--text-color);
            border-radius: 4px; cursor: pointer; transition: 0.2s; font-size: 0.9rem;
        }
        button:hover { background: #f0f0f0; color: #000; border-color: #ccc; }
        body.dark-theme button:hover { background: #333; color: #fff; border-color: #555; }

        /* 1. 상단 헤더 */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; background: var(--panel-bg); border-bottom: 1px solid var(--border-color);
        }
        #book-title { font-weight: bold; font-size: 1.1rem; max-width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        input[type="file"] { font-size: 0.85rem; color: var(--text-color); }

        /* 2. 설정 툴바 (폰트/테마) */
        #settings-toolbar {
            display: flex; gap: 20px; align-items: center;
            padding: 8px 20px; background: var(--panel-bg); border-bottom: 1px solid var(--border-color); font-size: 0.9rem;
        }
        .setting-group { display: flex; align-items: center; gap: 8px; }
        /* 테마 원형 버튼 스타일 */
        .theme-circle { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; box-shadow: inset 0 0 2px rgba(0,0,0,0.2);}
        .theme-circle:hover, .theme-circle.active { border-color: var(--primary-color); transform: scale(1.1); }

        /* 3. 메인 뷰어 영역 */
        #viewer-container {
            flex: 1; position: relative; width: 100%; max-width: 900px;
            margin: 0 auto; background: transparent; /* 책 자체 배경색을 따름 */
        }
        #viewer { height: 100%; width: 100%; }

        /* 4. 하단 네비게이터 */
        footer {
            background: var(--panel-bg); border-top: 1px solid var(--border-color);
            padding: 15px 20px; display: flex; flex-direction: column; gap: 10px; align-items: center;
        }
        .nav-buttons button { padding: 8px 20px; border-radius: 20px; font-size: 1rem; }
        .progress-info { width: 100%; max-width: 600px; display: flex; align-items: center; gap: 15px; font-size: 0.85rem; opacity: 0.8; }
        #progress-bar { flex: 1; height: 4px; accent-color: var(--primary-color); cursor: pointer;}

    </style>
</head>
<body class="default-theme"> <header>
    <div id="book-title">파일을 열어주세요</div>
    <input type="file" id="file-input" accept=".epub">
</header>

<div id="settings-toolbar">
    <div class="setting-group">
        <span>글자 크기:</span>
        <button id="font-down" title="작게">가-</button>
        <button id="font-up" title="크게" style="font-weight:bold;">가+</button>
    </div>
    <div class="setting-group">
        <span>테마:</span>
        <div class="theme-circle active" data-theme="default" style="background:#fff;" title="기본"></div>
        <div class="theme-circle" data-theme="sepia" style="background:#f4ecd8;" title="미색(눈편함)"></div>
        <div class="theme-circle" data-theme="dark" style="background:#333;" title="다크모드"></div>
    </div>
</div>

<div id="viewer-container">
    <div id="viewer"></div>
</div>

<footer>
    <div class="nav-buttons">
        <button id="prev">◀ 이전 페이지</button>
        <button id="next">다음 페이지 ▶</button>
    </div>
    <div class="progress-info">
        <span id="percent">0%</span>
        <input type="range" id="progress-bar" value="0" min="0" max="100" step="1">
        <span id="page-label"></span>
    </div>
</footer>


<script>
    // 전역 변수 설정
    let book = ePub();
    let rendition;
    let currentFontSize = 100; // 현재 폰트 크기 (%)

    const fileInput = document.getElementById("file-input");
    const progressBar = document.getElementById("progress-bar");

    // 1. 파일 열기 및 초기화
    fileInput.addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            if (rendition) rendition.destroy(); // 기존 책 제거
            
            book.open(event.target.result);
            
            // 뷰어 렌더링 설정
            rendition = book.renderTo("viewer", {
                width: "100%", height: "100%",
                flow: "paginated", // 페이지 넘김 방식
                allowScriptedContent: true // 일부 책의 스크립트 허용
            });

            // 2. 테마 등록 (책 내부 스타일용)
            rendition.themes.register("default", { "body": { "background": "#ffffff", "color": "#000000" } });
            rendition.themes.register("sepia", { "body": { "background": "#f4ecd8", "color": "#5b4636" } });
            // 다크모드는 책의 기본 스타일을 강제로 덮어써야 할 때가 많아 !important 사용
            rendition.themes.register("dark", { 
                "body": { "background": "#121212 !important", "color": "#cccccc !important" },
                "p, h1, h2, h3, h4, span, div": { "color": "inherit !important", "background-color": "transparent !important" }
            });

            // 초기 설정 적용 (폰트, 테마)
            rendition.themes.fontSize(currentFontSize + "%");
            applyTheme(document.body.classList[0].replace("-theme","") || 'default');

            // 책 표시
            rendition.display();

            // 메타데이터(제목) 불러오기
            book.loaded.metadata.then(meta => {
                document.getElementById("book-title").textContent = meta.title;
            });

            // 위치 정보 생성 (진행률 바용)
            book.ready.then(() => book.locations.generate(1024)).then(updateProgress);
            rendition.on("relocated", updateProgress);
        };
        reader.readAsArrayBuffer(file);
    });


    // ================= 기능 구현 =================

    // [기능 1] 폰트 크기 조절
    document.getElementById("font-up").addEventListener("click", () => {
        if (!rendition) return;
        currentFontSize += 10;
        rendition.themes.fontSize(currentFontSize + "%");
    });
    document.getElementById("font-down").addEventListener("click", () => {
        if (!rendition || currentFontSize <= 60) return; // 최소 크기 제한
        currentFontSize -= 10;
        rendition.themes.fontSize(currentFontSize + "%");
    });

    // [기능 2] 테마 변경
    const themeBtns = document.querySelectorAll('.theme-circle');
    themeBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            const themeName = e.target.dataset.theme;
            applyTheme(themeName);
            
            // 버튼 활성 상태 표시 UI 업데이트
            themeBtns.forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
        });
    });

    function applyTheme(themeName) {
        if (!rendition) return;
        // 1. 웹페이지 바깥 부분 테마 적용 (CSS 클래스 변경)
        document.body.className = themeName + "-theme";
        // 2. 책 내부 콘텐츠 테마 적용 (epub.js 테마 선택)
        rendition.themes.select(themeName);
    }


    // [기능 3] 네비게이션 및 진행률
    function updateProgress() {
        if (!book.locations || !rendition.currentLocation()) return;
        const currentLocation = rendition.currentLocation();
        const progress = book.locations.percentageFromCfi(currentLocation.start.cfi);
        const percentage = Math.floor(progress * 100);
        
        document.getElementById("percent").textContent = percentage + "%";
        progressBar.value = percentage;

        // 현재 페이지 / 전체 페이지 표시
        const currentPage = book.locations.locationFromCfi(currentLocation.start.cfi);
        const totalPages = book.locations.total;
        if(totalPages > 0) {
             document.getElementById("page-label").textContent = `${currentPage} / ${totalPages}`;
        }
    }

    document.getElementById("prev").addEventListener("click", () => rendition?.prev());
    document.getElementById("next").addEventListener("click", () => rendition?.next());
    
    // 프로그레스 바 드래그 이동
    progressBar.addEventListener("input", function() {
        const cfi = book.locations.cfiFromPercentage(progressBar.value / 100);
        rendition.display(cfi);
    });

    // [기능 4] 키보드 및 창 크기 대응
    document.addEventListener("keyup", e => {
        if (e.key === "ArrowLeft") rendition?.prev();
        if (e.key === "ArrowRight") rendition?.next();
    });
    window.addEventListener("resize", () => rendition?.resize());

</script>

</body>
</html>
