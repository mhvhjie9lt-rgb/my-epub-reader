<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Immersive Web Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --bg-color: #ffffff;
            --ui-bg: rgba(255, 255, 255, 0.95);
            --text-color: #333;
        }

        body.dark-theme {
            --bg-color: #121212; --ui-bg: rgba(30, 30, 30, 0.95); --text-color: #ccc;
        }

        body {
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            background-color: var(--bg-color); color: var(--text-color);
            font-family: 'Apple SD Gothic Neo', sans-serif;
        }

        /* 상하단 메뉴 공통 스타일 */
        .ui-bar {
            position: fixed; left: 0; width: 100%; background: var(--ui-bg);
            z-index: 100; transition: transform 0.3s ease;
            box-shadow: 0 0 10px rgba(0,0,0,0.1); backdrop-filter: blur(5px);
        }

        header { top: 0; height: 60px; display: flex; align-items: center; padding: 0 20px; transform: translateY(-100%); }
        header.show { transform: translateY(0); }

        footer { bottom: 0; padding: 15px 20px; transform: translateY(100%); display: flex; flex-direction: column; align-items: center; }
        footer.show { transform: translateY(0); }

        #settings-bar { top: 60px; height: 50px; display: flex; gap: 15px; align-items: center; padding: 0 20px; font-size: 0.9rem; transform: translateY(-220%); }
        #settings-bar.show { transform: translateY(0); }

        #viewer-container { width: 100%; height: 100vh; position: absolute; top: 0; left: 0; }
        #viewer { width: 100%; height: 100%; }

        /* 터치 및 클릭 레이어 */
        #touch-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }

        .theme-circle { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 1px solid #ccc; }
        .nav-btns button { padding: 8px 20px; border-radius: 20px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-size: 0.9rem; }
        #progress-bar { width: 250px; accent-color: var(--primary-color); cursor: pointer; }
    </style>
</head>
<body class="default-theme">

<header class="ui-bar">
    <div id="book-title" style="flex:1; font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-right:10px;">파일을 선택하세요</div>
    <input type="file" id="file-input" accept=".epub">
</header>

<div id="settings-bar" class="ui-bar">
    <span>글자 크기:</span>
    <button id="font-down">가-</button><button id="font-up">가+</button>
    <span style="margin-left:10px;">테마:</span>
    <div class="theme-circle" data-theme="default" style="background:#fff;" title="라이트"></div>
    <div class="theme-circle" data-theme="dark" style="background:#333;" title="다크"></div>
</div>

<div id="viewer-container">
    <div id="touch-layer"></div>
    <div id="viewer"></div>
</div>

<footer class="ui-bar">
    <div class="nav-btns" style="margin-bottom:12px;">
        <button id="prev">◀ 이전</button>
        <button id="next">다음 ▶</button>
    </div>
    <div style="display:flex; align-items:center; gap:15px; font-size:0.85rem; width:100%; max-width:500px; justify-content:center;">
        <span id="percent">0%</span>
        <input type="range" id="progress-bar" value="0">
        <span id="page-label">0/0</span>
    </div>
</footer>

<script>
    let book = ePub();
    let rendition;
    let currentFontSize = 100;
    let uiVisible = false;

    // UI 토글 함수
    function toggleUI() {
        uiVisible = !uiVisible;
        document.querySelectorAll('.ui-bar').forEach(bar => bar.classList.toggle('show', uiVisible));
    }

    // 방향키 이벤트 처리 함수
    function handleKeydown(e) {
        if (e.key === "ArrowLeft") rendition?.prev();
        if (e.key === "ArrowRight") rendition?.next();
        if (e.key === "Escape" && uiVisible) toggleUI(); // ESC 누르면 메뉴 닫기
    }

    // 1. 브라우저 메인 창에 키 이벤트 등록
    document.addEventListener("keydown", handleKeydown);

    document.getElementById("touch-layer").addEventListener("click", (e) => {
        const width = window.innerWidth;
        const x = e.clientX;
        if (x < width * 0.2) rendition?.prev();
        else if (x > width * 0.8) rendition?.next();
        else toggleUI();
    });

    document.getElementById("file-input").addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            if (rendition) rendition.destroy();
            book.open(event.target.result);
            rendition = book.renderTo("viewer", { width: "100%", height: "100%", flow: "paginated" });
            
            rendition.themes.register("default", { "body": { "background": "transparent", "color": "#000" }});
            rendition.themes.register("dark", { "body": { "background": "transparent", "color": "#ccc" }});
            
            rendition.display();

            // 2. 책 내부(iframe)에도 키 이벤트 등록 (이게 중요!)
            rendition.on("keydown", handleKeydown);

            book.loaded.metadata.then(meta => { document.getElementById("book-title").textContent = meta.title; });
            book.ready.then(() => book.locations.generate(1024)).then(updateProgress);
            rendition.on("relocated", updateProgress);
            
            uiVisible = false; toggleUI(); // 파일 열리면 메뉴 표시
        };
        reader.readAsArrayBuffer(file);
    });

    // 테마/폰트 조절 버튼 (이전과 동일)
    document.querySelectorAll('.theme-circle').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const theme = e.target.dataset.theme;
            document.body.className = theme + "-theme";
            rendition.themes.select(theme);
        });
    });

    document.getElementById("font-up").addEventListener("click", () => { currentFontSize += 10; rendition.themes.fontSize(currentFontSize + "%"); });
    document.getElementById("font-down").addEventListener("click", () => { if(currentFontSize > 70) currentFontSize -= 10; rendition.themes.fontSize(currentFontSize + "%"); });

    function updateProgress() {
        if (!book.locations || !rendition.currentLocation()) return;
        const loc = rendition.currentLocation();
        const progress = book.locations.percentageFromCfi(loc.start.cfi);
        document.getElementById("percent").textContent = Math.floor(progress * 100) + "%";
        document.getElementById("progress-bar").value = progress * 100;
        const currentPage = book.locations.locationFromCfi(loc.start.cfi);
        document.getElementById("page-label").textContent = `${currentPage} / ${book.locations.total}`;
    }

    document.getElementById("prev").addEventListener("click", () => rendition?.prev());
    document.getElementById("next").addEventListener("click", () => rendition?.next());
    document.getElementById("progress-bar").addEventListener("input", (e) => {
        const cfi = book.locations.cfiFromPercentage(e.target.value / 100);
        rendition.display(cfi);
    });
</script>
</body>
</html>
